# 移动端性能优化-加载优化篇

移动端页面布局越来越复杂，效果越来越炫，直接导致了文件越来越大，下载和运行速度越来越低，而速度低会造成不良影响会出现各种问题 —— 加载慢，数据慢，体验差。

出现问题了就需要去解决它，提升移动端性能主要从两方面着手：

1. 加载优化
2. 执行优化

## 加载优化策略

加载优化主要是提升首屏页面的加载速度和各种资源的加载速度，移动端资源加载的速度跟三个因素有关，分别是：移动网络带宽速度，设备性能（CPU，GPU，浏览器），页面本身。
提升加载性能需要从3个方面进行：

1. 优化请求
2. 缓存策略
3. 加载策略

### 优化请求

通常前端的请求方式都是 http 或 https 协议， 先了解一下它们的概念：

HTTP:
> HTTP 协议是无状态的应用层协议，意味着每次HTTP请求都需要建立通信链路、进行数据传输，而在服务器端，每个HTTP都需要启动独立的线程去处理。这些通信和服务的开销都很昂贵，**减少 HTTP 请求**的数目可有效提高访问性能。

HTTPS:
> HTTPS （全称：Hypertext Transfer Protocol over Secure Socket Layer），是以安全为目标的HTTP通道，简单讲是 HTTP 的安全版。即 HTTP 下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。它需要对数据进行加解密决定了**它比 HTTP 慢**。

针对 HTTP 请求有如下几种优化方案：

### 优化请求包大小

1. 代码压缩 代码压缩对于前端来说已经是很平常的事情了，现在有代码压缩的各种工具，目前流行的框架有 Webpack(最火爆)，rollup, Gulp ，Grunt。除非页面特别小，用户量也很少可以不考虑；
2. 开启 Gzip 压缩，通常web 服务器都会开启这项功能，前端不需要做什么，目前比较流行的就是 Gzip，将来可能会有更优化的压缩方案；
3. 不同网络环境（2G, 3G，4G, WiFi） 图片尺寸，由于网络的提速与普及，网络速度都很快了，为了提升移动端用户体验还需要 对视网膜高清屏做适配，提供 2x, 2.5x, 3x, 等等不同屏的图片加载。图片质量和图片大小成反比，可以酌情考虑。一般前端的 UI 切图可以考虑图片质量，服务器端返回的图片链接可以控制尺寸；
4. 合理减少 Header 字段和 cookie 大小， 请求和响应这些信息都会带上的，太大的cookie会严重影响数据传输，减少的大小是双倍的回报，因此哪些数据需要写入cookie需要慎重考虑，尽量减少cookie中传输的数据量。
5. 合理利用MTU策略：通常情况下，我们认为TCP网络传输的最大传输单元（Maximum Transmission Unit，`MTU`）为**1500B**，即网络一个`RTT`（Round-Trip Time，网络请求往返时间）时间内可以传输的数据量最大为**1500字节**。因此，在前后端分离的开发模式中，**尽量保证页面的HTML内容在 1KB 以内**，这样整个HTML的内容请求就可以在一个RTT时间内请求完成，最大限度地提高HTML载入速度。
6. 首屏加载时间控制：
    * 3s 完成（用户最大容忍度 5s）
    * 网络平均速度
    * 不要超过 1041KB，（考虑打开响应，网络连接至少 600ms）

### 减少请求次数

1. 减少http请求的主要手段是 合并CSS、合并javascript、合并图片(雪碧图)。将浏览器一次访问需要的javascript和CSS合并成一个文件，这样浏览器就只需要一次请求。图片也可以合并，多张图片合并成一张，如果每张图片都有不同的超链接，可通过CSS偏移响应鼠标点击操作，构造不同的 URL ；
2. 避免重定向（一次重定向至少 600 ms）；
3. 避免重复资源请求；
4. 减少并且请求数量（android 4个， ios 5以后 可以支持 6 个）；

### 解耦请求依赖

1. 模块化文件并行加载/依赖执行：在移动端资源加载中，尽量保证JavaScript资源并行加载，主要指的是模块化JavaScript资源的异步加载，例如AMD的异步模块，使用并行的加载方式能够缩短多个文件资源的加载时间。
2. 首屏CGI提前（组件）
3. inline首屏必备的CSS和JavaScript：通常为了在HTML加载完成时能使浏览器中有基本的样式，需要将页面渲染时必备的CSS和JavaScript通过 `<script>` 或 `<style>` 内联到页面中，避免页面HTML载入完成到页面内容展示这段过程中页面出现空白。
4. 异步加载非首屏：首屏以外的资源使用异步加载，如果空闲时可预先加载，对于移动端首屏加载后可能会被使用的资源，需要在首屏完成加载后尽快进行加载，保证在用户需要浏览时已经加载完成，这时候如果再去异步请求就显得很慢。

### 连接优化

1. 支持 keep-alive 长连接
2. 网络时间
3. DNS Prefetch(预解析) 设置文件资源的DNS预解析，让浏览器提前解析获取静态资源的主机IP，避免等到请求时才发起DNS解析请求。通常在移动端HTML中可以采用如下方式完成。

```html
<!-- cdn域名预解析 -->
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.domain.com">
```

4. 尝试使用SPDY和HTTP 2: 在条件允许的情况下可以考虑使用SPDY协议来进行文件资源传输，利用连接复用加快传输过程，缩短资源加载时间。HTTP 2在未来也是可以考虑尝试的。

### 加载策略

1. 首屏加载；
2. 使用服务器端数据渲染：使用后端数据渲染的方式可以加快页面内容的渲染展示，避免空白页面的出现，同时可以解决移动端页面SEO的问题。如果条件允许，后端数据渲染是一个很不错的实践思路。
3. 按需加载（模块化）
4. 图片资源：懒加载，滚动加载。图片很小可以使用 base64，单色调图片可以使用 iconfont。
5. Media Query 媒体查询

### 缓存策略

1. Cache
    * Browser cache 浏览器缓存（一年）
    * App cache （选择）
    * 离线包：native 下必须
2. web Storage
    * sesstion storage 不能存储过大的数据
    * local storage 不能存储过大的数据
    * native storage 原生 支持大数据
3. cookie
4. Web DB
    * indexedDB
    * Web SQL
5. 合理缓存 CGI 数据 (local, ajax)

### 终极解决方案 PWA

`PWA` （Progressive Web App）渐进式Web应用程序, 核心技术 Service Worker。其它类似方案： 小程序（app内应用），快应用（中国手机厂商的应用）。PWA 是浏览器厂商的应用，更广泛一些，但是缺少原生 api 的支持，小程序和快应用使用原生渲染性能更好，都可以尝试一下。

**注：**
`CGI` [通用网关接口](https://baike.baidu.com/item/CGI/607810);
`HTTPS` 同样支持所有 HTTP 的优化方式，这里有专门针对 [https 的性能优化](https://zhuanlan.zhihu.com/p/25290538)