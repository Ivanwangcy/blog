# Taro 3 升级指南

- jsx 不支持 hidden 属性, 使用 jsx && 语法控制；
- 样式调整，组件直接受全局样式影响，不再需要设置 addGlobalClass
- 在 Taro Next，Taro 的专有 Hooks（例如 usePageScroll, useReachBottom）从 @tarojs/taro 中引入，框架自己的 Hooks （例如 useEffect, useState）从对应的框架引入。
- @withWeapp装饰器中的created、onLoad、onLaunch、onShow钩子，options类型不再是页面options参数，是 RouterInfo 对象，页面options参数对应路由对象的 params 字段。（此问题taro 3.1.x版本已经修复）`Taro.getCurrentInstance().router.params`
- 页面实例的withWeapp装饰器中，onLoad会执行两次，需要用标记位记录是否执行了onLoad，防止重复执行。组件onLoad只执行一遍，不用加标记位处理（新页面不要用withWeapp装饰器）。（此问题taro3.1.x版本已经修复）
- this.$router.params 使用 Taro.getCurrentInstance().router.params 替代；
- let app = Taro.getApp() 使用 let app = Taro.Current 替代；
- render函数中，渲染条件必须为布尔类型，否则会渲染判断条件。
- 页面配置信息：单独使用 page.config.js 文件；例如：导航栏样式
- Taro.createRef() 替换成 React.createRef()
- dataset 建议都使用小写，可以适配多端；

## 常见错误

- 使用 Taro 3.0 版本写微信小程序写类组件控制台输出：
  
`MiniProgramError Super expression must either be null or a function`

需要更新写法：

React.Component 代替 Taro.Component

- [问题描述：const taro = Taro；执行taro.getNetworkType({})报错]

Taro 版本统一，保持所有库都是一个版本；不一致时，删除所有包和 lock 文件，重新安装。

- 样式都被提取到公共文件了，组件样式重名的可能被覆盖需要调整；

## 分包优化

修改 webpack 配置，利用 splitChunks 特性，将子包公共文件单独提取，避免主包过大；

通用的子包公共文件提取：@TODO

```js
webpackChain (chain, webpack) {
      chain.plugin('analyzer')
        .use(require('webpack-bundle-analyzer').BundleAnalyzerPlugin, [])
        const config = chain.optimization.get('splitChunks')
        chain.optimization
          .splitChunks({
            ...config,
            cacheGroups: {
              ...config.cacheGroups,
              subutils: {
                name: 'packageB/sub-common',
                minChunks: 2,
                test: module => /[\\/]packageB[\\/]/.test(module.resource),
                priority: 200
              }
            }
          })
    },
    addChunkPages (pages) {
      pages.set('packageB/sub1', ['packageB/sub-common'])
      pages.set('packageB/sub2', ['packageB/sub-common'])
    }
```

## 子包公共文件提取

```js
const { stats, config } = await compile('subpackages', {
      webpackChain (chain) {
        const config = chain.optimization.get('splitChunks')
        chain.optimization
          .splitChunks({
            ...config,
            cacheGroups: {
              ...config.cacheGroups,
              subutils: {
                name: 'sub-utils',
                minChunks: 2,
                test: module => /[\\/]packageA[\\/]/.test(module.resource),
                priority: 200
              }
            }
          })
      },
      addChunkPages (pages) {
        pages.set('packageA/detail/index', ['sub-utils'])
        pages.set('packageA/my/index', ['sub-utils'])
      }
    })
```

## 自定义的装饰器

自定义装饰器和 Redux 装饰器冲突问题，如果出现如下报错信息：
taro 3 TypeError: Super expression must either be null or a function

```js
// 错误的写法
@custom
@connect

// 正确的装饰器顺序
@connect
@custom
```
