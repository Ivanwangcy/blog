# 小程序自动化测试

随着需求迭代，小程序项目的页面功能越来越多，业务逻辑也会变得更加复杂，有些业务场景也不太好测试，只靠人工处理难以面面俱到，很容易出现疏漏，每次上线都需要做大量的重复性工作。因此我们需要这样一款工具来实现自动化，降低人工成本，提高质量。

微信小程序为我们提供了：[miniprogram-automator](https://www.npmjs.com/package/miniprogram-automator) 工具。

>> miniprogram-automator
基于miniprogram-automator的文档描述简单总结一下，当通过命令打开开发版微信开发者工具的自动化接口并连接自动化接口后，此工具可提供以下能力：

- MiniProgram：获取小程序信息（页面堆栈、系统信息、页面内容），控制小程序（跳转页面、切换tab、调用方法）
- Page：获取页面信息（路径、元素、数据、结构），控制页面（设置渲染数据、调用方法）
- Element：获取元素信息（属性、样式、内容、位置），操控元素（点击、长按、调用方法）

所以小程序自动化控制的实现依赖于开发版小程序开发者工具以及miniprogram-automator工具。小程序开发者工具命令行用来打开指定自动化操作服务端口。（开发者工具版本需高于v1.02.1906042）。miniprogram-automator工具用来操作开发者工具中运行的小程序并获取所需的信息。对于测试需求可以结合jest框架进行测试用例的组织和断言。

## 自动化测试准备

1. 首先：打开开发者工具菜单中的设置->安全设置->服务端口；
2. 调用开发者工具命令行打开项目与指定自动化操作服务端口；

## Mac 启动命令

# 开发者工具系统默认路径
# /Applications/wechatwebdevtools.app/Contents/MacOS

```sh
➜  MacOS ./cli --auto /Users/xxx/workspace/miniprogram-demo --auto-port 9420

```

多端测试框架：

微信小程序自动化测试框架：https://developers.weixin.qq.com/miniprogram/dev/devtools/auto/demo.html

百度小程序自动化测试框架：https://smartprogram.baidu.com/docs/develop/devtools/auto/quick-start/





>> [小程序自动化测试总结](https://www.imweb.io/topic/5d1a0c7df7b5692b080f2602)

## 编写测试用例脚本

创建 index.spec.js 文件

```

const automator = require('miniprogram-automator');

describe('小程序自动化测试用例', () => {
  let miniProgram;
  // 运行测试前调用
  beforeAll(async () => {
    miniProgram = await automator.connect({
      wsEndpoint: 'ws://localhost:9420',
    });
  });
  // 运行测试后调用
  afterAll(() => {
    miniProgram.disconnect();
  });
  // 测试内容
  it('nohost检测', async () => {
    const page = await miniProgram.reLaunch('/page/component/index');
    const nohostButton = await page.$('nohost');
    expect(nohostButton).toBeNull();
  });
});
```
## 运行测试用例

```
# 如果运行过了，需要增加 --detectOpenHandles，出现如下错误
# This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
$ jest miniprogram-demo-test/index.spec.js --detectOpenHandles
```


## Tiga 自动化框架

```sh
npm i @jd/tiga
```
>> https://aotu.io/notes/2020/07/13/jx-automated-testing-weapp/index.html
