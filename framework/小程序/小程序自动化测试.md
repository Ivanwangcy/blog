# 小程序自动化测试

随着需求迭代，小程序项目的页面功能越来越多，业务逻辑也会变得更加复杂，有些业务场景也不太好测试，只靠人工处理难以面面俱到，很容易出现疏漏，每次上线都需要做大量的重复性工作。因此我们需要这样一款工具来实现自动化，降低人工成本，提高质量。

微信小程序为我们提供了：[miniprogram-automator](https://www.npmjs.com/package/miniprogram-automator) 工具。

>> miniprogram-automator
基于miniprogram-automator的文档描述简单总结一下，当通过命令打开开发版微信开发者工具的自动化接口并连接自动化接口后，此工具可提供以下能力：

- MiniProgram：获取小程序信息（页面堆栈、系统信息、页面内容），控制小程序（跳转页面、切换tab、调用方法）
- Page：获取页面信息（路径、元素、数据、结构），控制页面（设置渲染数据、调用方法）
- Element：获取元素信息（属性、样式、内容、位置），操控元素（点击、长按、调用方法）

所以小程序自动化控制的实现依赖于开发版小程序开发者工具以及miniprogram-automator工具。小程序开发者工具命令行用来打开指定自动化操作服务端口。（开发者工具版本需高于v1.02.1906042）。miniprogram-automator工具用来操作开发者工具中运行的小程序并获取所需的信息。对于测试需求可以结合jest框架进行测试用例的组织和断言。

## 自动化测试准备

1. 首先：打开开发者工具菜单中的设置->安全设置->服务端口；
2. 调用开发者工具命令行打开项目与指定自动化操作服务端口；

## Mac 启动命令

# 开发者工具系统默认路径
# /Applications/wechatwebdevtools.app/Contents/MacOS

```sh
➜  MacOS ./cli --auto /Users/xxx/workspace/miniprogram-demo --auto-port 9420

```

多端测试框架：

微信小程序自动化测试框架：https://developers.weixin.qq.com/miniprogram/dev/devtools/auto/demo.html

百度小程序自动化测试框架：https://smartprogram.baidu.com/docs/develop/devtools/auto/quick-start/





>> [小程序自动化测试总结](https://www.imweb.io/topic/5d1a0c7df7b5692b080f2602)

## 编写测试用例脚本

创建 index.spec.js 文件

```

const automator = require('miniprogram-automator');

describe('小程序自动化测试用例', () => {
  let miniProgram;
  // 运行测试前调用
  beforeAll(async () => {
    miniProgram = await automator.connect({
      wsEndpoint: 'ws://localhost:9420',
    });
  });
  // 运行测试后调用
  afterAll(() => {
    miniProgram.disconnect();
  });
  // 测试内容
  it('nohost检测', async () => {
    const page = await miniProgram.reLaunch('/page/component/index');
    const nohostButton = await page.$('nohost');
    expect(nohostButton).toBeNull();
  });
});
```
## 运行测试用例

```
# 如果运行过了，需要增加 --detectOpenHandles，出现如下错误
# This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
$ jest miniprogram-demo-test/index.spec.js --detectOpenHandles
```
## 容灾演习

## Tiga 自动化框架

```sh
npm i @jd/tiga
```
>> https://aotu.io/notes/2020/07/13/jx-automated-testing-weapp/index.html


Tiga 是一个基于 puppeteer 和 miniprogram-automator 实现的高阶 SDK，它封装了一系列统一的 API 来操控 Chromium / 小程序开发者工具，实现一套脚本用例跑通浏览器和小程序两端的目的。

### Tiga 主要为了解决三种场景：

- 跨端项目的自动化测试

由于浏览器和微信小程序的底层架构差异：浏览器应用程序允许同时存在若干个标签页，每个标签独立一个页面实例；而在微信小程序中没有标签的概念，每个页面都是一个页面实例，多个页面共用一个逻辑线程。这会给 API 的统一带来较大的麻烦，完美 Cover 两端的所有场景往往是非常困难的。

Tiga 的 API 设计考虑以常见的自动化测试场景为出发点，优先解决单标签 Web 应用和小程序的自动化场景，无可避免地对某些关键 API 作出妥协和牺牲（如浏览器环境的 App.goto() 方法），同时也对部分高频 API 在 App 和 Page 两个层级都进行实现，最大限度地覆盖跨端项目的场景。

- 小程序复杂的请求拦截

熟悉 miniprogram-automator 小程序官方自动化 SDK 的应该都知道，目前实现请求拦截只能通过 miniProgram.mockWxMethod 方法来覆盖 wx.request 接口的调用结果，这种方式无法实现动态拦截（因为 miniProgram.mockWxMethod 的参数会被序列化），且无法拦截 WebSocket 请求。

Tiga 引入了 AnyProxy 来启动本地代理服务，通过代理来完成请求拦截，这使得小程序自动化的请求处理非常灵活自由。

Tiga 的请求拦截采用的渐进式方案，简单场景可以选择不开启代理服务，通过 Http Rule 机制即可实现响应数据覆写。

- 测试用例脚本复用

有 UI 自动化测试相关经验的同学应该深有体会，测试用例的编写往往是繁杂且枯燥的，Tiga 为了解决用例脚本复用的问题，实现了一套模板化架构，开发者可以结合自身场景把可复用的测试流程抽象出一套自定义用例模板，后续仅需要填充相应的配置即可完成自动化测试，轻松实现 配置即用例。除此之外，Tiga 也会参考通用场景提供预置的用例模板，供开发者开箱即用。





