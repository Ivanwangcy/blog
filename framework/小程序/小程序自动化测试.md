# 小程序自动化测试

随着需求迭代，小程序项目的页面功能越来越多，业务逻辑也会变得更加复杂，有些业务场景也不太好测试，只靠人工处理难以面面俱到，很容易出现疏漏，每次上线都需要做大量的重复性工作。因此我们需要这样一款工具来实现自动化，降低人工成本，提高质量。

微信小程序为我们提供了：[miniprogram-automator](https://www.npmjs.com/package/miniprogram-automator) 工具。

## 自动化测试准备

1. 首先：打开开发者工具菜单中的设置->安全设置->服务端口；
2. 调用开发者工具命令行打开项目与指定自动化操作服务端口；

## Mac 启动命令

```sh
➜  MacOS ./cli --auto /Users/xxx/workspace/miniprogram-demo --auto-port 9420

```

多端测试框架：

微信小程序自动化测试框架：https://developers.weixin.qq.com/miniprogram/dev/devtools/auto/demo.html

百度小程序自动化测试框架：https://smartprogram.baidu.com/docs/develop/devtools/auto/quick-start/





>> [小程序自动化测试总结](https://www.imweb.io/topic/5d1a0c7df7b5692b080f2602)

## 编写测试用例脚本

创建 index.spec.js 文件

```

const automator = require('miniprogram-automator');

describe('小程序自动化测试用例', () => {
  let miniProgram;
  // 运行测试前调用
  beforeAll(async () => {
    miniProgram = await automator.connect({
      wsEndpoint: 'ws://localhost:9420',
    });
  });
  // 运行测试后调用
  afterAll(() => {
    miniProgram.disconnect();
  });
  // 测试内容
  it('nohost检测', async () => {
    const page = await miniProgram.reLaunch('/page/component/index');
    const nohostButton = await page.$('nohost');
    expect(nohostButton).toBeNull();
  });
});
```
## 运行测试用例

```
# 如果运行过了，需要增加 --detectOpenHandles，出现如下错误
# This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
$ jest miniprogram-demo-test/index.spec.js --detectOpenHandles
```
